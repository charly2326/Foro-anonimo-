<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil de Usuario</title>

    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<style>

/* Estilos del contenedor de perfil */
#profileContainer {
document.getElementById("openEditProfileFromModal").addEventListener("click", function () {
    // Cerrar el modal del perfil
    closeModal();

    // Abrir el modal de edici√≥n de perfil
    openEditProfileModal();
});
    position: fixed;
    top: 10px;
    right: 10px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #ddd; /* Color para visualizar */
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
}

#profileContainer img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}



.modal {
    display: none;
    position: fixed;
    inset: 0;
    align-items: center;
    justify-content: center;
    z-index: 50;
}

.modal-overlay {
    position: fixed;
    inset: 0;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
}

.modal-content {
    transition: transform 0.3s ease-out, opacity 0.3s ease-out;
}

.hidden {
    display: none !important;
}

.scale-100 {
    transform: scale(1);
    opacity: 1;
}

.scale-95 {
    transform: scale(0.95);
    opacity: 0;
}

#profileContainer {
    display: none;
}





</style>
</head>
<body class="bg-gray-100">
    <div class="flex min-h-screen bg-gray-50">
    <!-- Sidebar -->
    <aside class="w-64 bg-white p-5 shadow-md sticky top-0 h-screen overflow-y-auto">
        <!-- Logo/Brand -->
        <div class="mb-8">
            <h1 class="text-2xl font-bold text-blue-600">SocialApp</h1>
        </div>

        <!-- Contenedor de Login / Perfil -->
        <div id="authContainer" class="mb-6">
            <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg mb-4 transition duration-200">
                Iniciar sesi√≥n
            </button>

            <!-- Contenedor del perfil (oculto por defecto) -->
<div id="profileContainerSidebar" class="hidden flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-100 cursor-pointer transition duration-200">
    <img id="profilePicSidebar" src="https://via.placeholder.com/50" alt="Perfil" class="w-10 h-10 rounded-full object-cover">
    <span id="usernameSidebar" class="font-medium">Usuario</span>
</div>

        <!-- Men√∫ de navegaci√≥n -->
        <nav class="mb-6">
            <ul class="space-y-2">
                <li>
                    <a href="#" class="flex items-center p-3 rounded-lg hover:bg-gray-100 transition duration-200">
                        <span class="mr-3">üì¶</span>
                        <span>Pedidos disponibles</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center p-3 rounded-lg hover:bg-gray-100 transition duration-200">
                        <span class="mr-3">üîî</span>
                        <span>Notificaciones</span>
                        <span class="ml-auto bg-red-500 text-white text-xs px-2 py-1 rounded-full">3</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-center p-3 rounded-lg hover:bg-gray-100 transition duration-200">
                        <span class="mr-3">üí¨</span>
                        <span>Mensajes</span>
                    </a>
                </li>
                <li>
                    <button id="editProfileBtn" class="w-full flex items-center p-3 rounded-lg hover:bg-gray-100 transition duration-200">
                        <span class="mr-3">‚úèÔ∏è</span>
                        <span>Editar perfil</span>
                    </button>
                </li>
            </ul>
        </nav>

        <button class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg mt-4 transition duration-200 shadow-md">
            + Crear publicaci√≥n
        </button>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 max-w-2xl mx-auto">
  <!-- Creador de publicaciones -->
  <div class="bg-white p-5 rounded-xl shadow-md mb-6">
    <textarea id="postInput" placeholder="¬øQu√© necesitas?"
      rows="3"
      class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>

    <div class="flex items-center justify-between mb-3">
      <div>
        <label for="postImageInput" class="cursor-pointer text-gray-600 hover:text-blue-600 transition">
          üì∑ Foto/Video
        </label>
        <input id="postImageInput" type="file" accept="image/*,video/*" class="hidden">
      </div>
      <span id="fileInfo" class="text-sm text-gray-500 truncate max-w-xs"></span>
    </div>

    <button id="publishBtn" disabled
      class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg transition">
      Publicar
    </button>
  </div>

  <!-- Contenedor de publicaciones -->
  <div id="postsContainer" class="space-y-4"></div>
</main>

    <!-- Trends Section -->
    <aside class="w-80 p-5 bg-white shadow-md sticky top-0 h-screen overflow-y-auto hidden lg:block">
        <div class="bg-gray-100 p-4 rounded-xl mb-6">
            <h2 class="font-bold text-lg mb-3">üìå Pedidos recientes</h2>
            <ul class="space-y-3">
                <li>
                    <a href="#" class="flex items-start p-2 rounded-lg hover:bg-gray-200 transition duration-200">
                        <span class="bg-blue-100 text-blue-600 rounded-full p-2 mr-3">#1</span>
                        <div>
                            <h3 class="font-medium">Dise√±o de logo</h3>
                            <p class="text-sm text-gray-600">5 ofertas recibidas</p>
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-start p-2 rounded-lg hover:bg-gray-200 transition duration-200">
                        <span class="bg-blue-100 text-blue-600 rounded-full p-2 mr-3">#2</span>
                        <div>
                            <h3 class="font-medium">Desarrollo web</h3>
                            <p class="text-sm text-gray-600">3 ofertas recibidas</p>
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" class="flex items-start p-2 rounded-lg hover:bg-gray-200 transition duration-200">
                        <span class="bg-blue-100 text-blue-600 rounded-full p-2 mr-3">#3</span>
                        <div>
                            <h3 class="font-medium">Traducci√≥n</h3>
                            <p class="text-sm text-gray-600">2 ofertas recibidas</p>
                        </div>
                    </a>
                </li>
            </ul>
        </div>

        <div class="bg-gray-100 p-4 rounded-xl">
            <h2 class="font-bold text-lg mb-3">üî• Tendencias</h2>
            <ul class="space-y-2">
                <li>
                    <a href="#" class="block p-2 text-blue-600 hover:bg-gray-200 rounded-lg transition duration-200">
                        #Dise√±oGrafico
                    </a>
                </li>
                <li>
                    <a href="#" class="block p-2 text-blue-600 hover:bg-gray-200 rounded-lg transition duration-200">
                        #DesarrolloWeb
                    </a>
                </li>
                <li>
                    <a href="#" class="block p-2 text-blue-600 hover:bg-gray-200 rounded-lg transition duration-200">
                        #Freelancer
                    </a>
                </li>
            </ul>
        </div>
    </aside>
</div>


    <!-- Modal de Login -->
    <div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center w-96 relative">
            <h2 class="text-xl font-bold mb-4">Bienvenido</h2>
            <p class="text-gray-600 mb-4">Elige una opci√≥n para continuar</p>

            <!-- Bot√≥n para iniciar sesi√≥n como vendedor -->
            <button id="sellerLoginBtn" class="w-full flex items-center justify-center bg-blue-600 text-white p-2 rounded mb-2">
                <img src="https://cdn-icons-png.flaticon.com/512/3081/3081559.png" class="w-6 h-6 mr-2">
                Continuar para vendedores
            </button>

            <!-- Bot√≥n para iniciar sesi√≥n con Google -->
            <button id="googleLoginBtn" class="w-full flex items-center justify-center bg-red-600 text-white p-2 rounded">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6 mr-2">
                Continuar con Google
            </button>

            <!-- Bot√≥n para cerrar el modal -->
            <button id="closeModal" class="absolute top-2 right-2 text-gray-600 text-xl">&times;</button>
        </div>
    </div>

    <!-- Contenedor del perfil -->
    <div id="profileContainer" class="hidden flex items-center space-x-2 cursor-pointer">
        <img id="profilePic" src="https://via.placeholder.com/40" alt="Perfil" class="w-10 h-10 rounded-full">
        <span id="profileName" class="font-semibold"></span>
    </div>

    
    <!-- MODAL PARA EDITAR PERFIL -->
<div id="editProfileModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg text-center w-96 relative">
    <button id="closeEditProfileModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">&times;</button>
    <h2 class="text-xl font-bold mb-4">Editar Perfil</h2>

    <!-- Imagen de Perfil -->
    <img id="editProfilePic" src="https://via.placeholder.com/80" class="w-20 h-20 rounded-full mx-auto mb-3">

    <!-- Input para cambiar nombre -->
    <input id="editProfileName" type="text" class="border p-2 w-full rounded mb-4" placeholder="Nuevo nombre">

    <!-- NUEVOS CAMPOS: Nombre de usuario y biograf√≠a -->
    <input id="editProfileUsername" type="text" class="border p-2 w-full rounded mb-4" placeholder="Nombre de usuario (ej. @charly)">
    <textarea id="editProfileBio" class="border p-2 w-full rounded mb-4" rows="3" placeholder="Biograf√≠a del usuario..."></textarea>

    <!-- Bot√≥n para guardar cambios -->
    <button id="saveProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-2 w-full">Guardar cambios</button>

    <!-- üîÑ Bot√≥n para cambiar a cuenta de vendedor -->
    <button id="switchToSellerBtn" class="bg-yellow-500 text-white px-4 py-2 rounded mb-2 w-full">Cambiar a cuenta de vendedor</button>

    <!-- Bot√≥n para cerrar sesi√≥n -->
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded w-full">Cerrar sesi√≥n</button>
  </div>
</div>

   

   <!-- MODAL DEL PERFIL -->
<div id="profileModal" class="modal hidden fixed inset-0 flex items-center justify-center z-50">
    <!-- Fondo oscuro difuminado -->
    <div id="modalOverlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 backdrop-blur-md"></div>

    <!-- Contenido del modal -->
    <div id="modalContent" class="bg-white p-6 rounded-lg shadow-lg text-center w-96 relative transform scale-95 opacity-0 transition-all duration-300 ease-in-out">

        <!-- Bot√≥n de cerrar -->
        <button id="closeProfileModal" class="absolute top-2 right-2 text-gray-600 text-2xl hover:text-gray-800">
            &times;
        </button>

        <!-- Foto de perfil con opci√≥n de cambio -->
        <label for="profilePicInput" class="cursor-pointer block">
            <img id="profilePicModal" src="https://via.placeholder.com/80" class="w-24 h-24 rounded-full mx-auto mb-3 border-2 border-gray-300">
        </label>
        <input type="file" id="profilePicInput" accept="image/*" class="hidden">
        <button id="saveProfilePicBtn" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition mt-2 hidden">
            Guardar Foto
        </button>

        <!-- Nombre y biograf√≠a -->
        <h2 class="text-xl font-bold text-gray-900" id="modalProfileName">Owen</h2>
        <p id="modalProfileUsername" class="text-gray-600">@charly</p>
        <p id="modalProfileBio" class="text-gray-500 text-sm mb-4">Esta es la biograf√≠a del usuario.</p>

        <!-- Bot√≥n de editar perfil -->
        <button id="openEditProfileFromModal" class="bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition">
            Editar perfil
        </button>

        <!-- Informaci√≥n del usuario -->
        <div class="flex justify-around text-gray-700 text-sm mt-3">
            <span><b>1</b> Publicaciones</span>
            <span><b>1</b> Siguiendo</span>
            <span><b>100</b> Seguidores</span>
        </div>

        <!-- Timeline -->
        <h3 class="mt-4 font-bold text-gray-800">Timeline</h3>
        <div class="bg-gray-100 p-2 rounded mt-2 shadow-sm">Primer Publicaci√≥n</div>
        <div class="bg-gray-100 p-2 rounded mt-2 shadow-sm">Segunda Publicaci√≥n</div>
    </div>
</div>


    <!-- MODAL PARA VENDEDORES -->
<div id="sellerProfileModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div id="sellerModalContent" class="bg-white p-6 rounded-lg shadow-lg text-center w-[500px] relative">

    <!-- Bot√≥n de cerrar -->
    <button id="closeSellerModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">
      &times;
    </button>

    <!-- Imagen de perfil -->
    <img id="sellerProfilePic" src="https://via.placeholder.com/100" class="w-24 h-24 rounded-full mx-auto mb-2" />

    <h2 id="sellerName" class="text-xl font-bold">Nombre del Vendedor</h2>
    <p id="sellerUsername" class="text-gray-600">@usuario</p>
    <p id="sellerBio" class="text-gray-500 text-sm mb-4">Biograf√≠a del vendedor.</p>

    <!-- Botones funcionales -->
    <button id="openOrdersModal" class="bg-green-500 text-white px-4 py-2 rounded mb-2 w-full">üì¶ Ver pedidos</button>
    <button id="openEarningsModal" class="bg-yellow-500 text-white px-4 py-2 rounded mb-2 w-full">üí∞ Gestionar ingresos</button>
    <button id="editSellerProfileBtn" class="bg-blue-500 text-white px-4 py-2 rounded mb-2 w-full">‚úè Editar perfil</button>

    <!-- Estad√≠sticas -->
    <div class="flex justify-around text-gray-700 text-sm mt-3">
      <span><b id="sellerTweets">0</b> Publicaciones</span>
      <span><b id="sellerFollowing">0</b> Siguiendo</span>
      <span><b id="sellerFollowers">0</b> Seguidores</span>
    </div>

    <!-- Historial -->
    <h3 class="mt-4 font-bold text-gray-800">Historial de Ventas</h3>
    <div class="bg-gray-100 p-2 rounded mt-2">√öltimo Pedido</div>
    <div class="bg-gray-100 p-2 rounded mt-2">Producto M√°s Vendido</div>
  </div>
</div>


<!-- MODAL: Ver Pedidos -->
<div id="ordersModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-[400px] text-center relative">
    <button id="closeOrdersModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">&times;</button>
    <h2 class="text-xl font-bold mb-4">üì¶ Tus Pedidos</h2>
    <div class="text-sm text-gray-600">
      <p>Aqu√≠ aparecer√°n los pedidos realizados por tus compradores.</p>
    </div>
  </div>
</div>

<!-- MODAL: Gestionar Ingresos -->
<div id="earningsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white p-6 rounded-lg shadow-lg w-[400px] text-center relative">
    <button id="closeEarningsModal" class="absolute top-2 right-2 text-gray-600 text-xl hover:text-gray-800">&times;</button>
    <h2 class="text-xl font-bold mb-4">üí∞ Gestionar Ingresos</h2>
    <div class="text-sm text-gray-600">
      <p>Resumen de tus ingresos y opciones para retirar fondos.</p>
    </div>
  </div>
</div>


<!-- Modal de imagen de perfil -->
<div id="profilePicPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
  <div class="w-40 h-40 rounded-full overflow-hidden border-4 border-white shadow-lg">
    <img id="previewProfilePic" src="" class="w-full h-full object-cover" />
  </div>
</div>



<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import {
    getAuth,
    signInWithPopup,
    GoogleAuthProvider,
    onAuthStateChanged,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    addDoc,
    serverTimestamp,
    query,
    orderBy,
    onSnapshot,
    collection
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Aqu√≠ contin√∫a el resto de tu script...


		
    // üî• Configuraci√≥n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAPOx1dEkYWE7q3U3VVoicnUuJDSDYnBnA",
        authDomain: "owen-41fb9.firebaseapp.com",
        projectId: "owen-41fb9",
        storageBucket: "owen-41fb9.appspot.com",
        appId: "1:1002523132638:web:fb404d19937fe4293d784f"
    };

    // üöÄ Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();



    const profilePicInput = document.getElementById("profilePicInput");
    const saveProfilePicBtn = document.getElementById("saveProfilePicBtn");
    const profilePicModal = document.getElementById("profilePicModal");

    profilePicInput.addEventListener("change", function () {
    const file = profilePicInput.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            profilePicModal.src = e.target.result; // Vista previa de la imagen
        };
        reader.readAsDataURL(file);
        saveProfilePicBtn.classList.remove("hidden"); // Muestra el bot√≥n de guardar
    }
});

     
   saveProfilePicBtn.addEventListener("click", async function () {
    const user = auth.currentUser;
    if (!user || !profilePicInput.files.length) {
        alert("‚ùå No hay usuario autenticado o no se seleccion√≥ una imagen.");
        return;
    }

    const file = profilePicInput.files[0];
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "Tweetsocial"); // üîπ Cambia esto por el nuevo preset que configuraste

    try {
        alert("üì§ Subiendo imagen a Cloudinary...");
        const response = await fetch("https://api.cloudinary.com/v1_1/dz70korgo/image/upload", {
            method: "POST",
            body: formData
        });

        const data = await response.json();

        // üö® Verificar si la respuesta de Cloudinary es v√°lida
        if (!data.secure_url) {
            throw new Error("No se recibi√≥ una URL v√°lida de Cloudinary.");
        }

        const photoURL = data.secure_url;
        alert("‚úÖ Imagen subida correctamente. URL: " + photoURL);

        // Guardar en Firestore
        const userRef = doc(db, "usuarios", user.uid);
        await setDoc(userRef, { modalPhotoURL: photoURL }, { merge: true });

        alert("‚úÖ modalPhotoURL guardado en Firestore: " + photoURL);

        // ‚úÖ Actualizar la UI en ambos modales
        document.getElementById("profilePicModal").src = photoURL;
        document.getElementById("editProfilePic").src = photoURL; // <--- üî• ESTA ES LA L√çNEA NUEVA

        saveProfilePicBtn.classList.add("hidden");

    } catch (error) {
        alert("‚ùå Error al subir la imagen: " + error.message);
        console.error("Error detallado:", error);
    }
});


    // üìå Funci√≥n para iniciar sesi√≥n con Google
    
    // üìå Funci√≥n para iniciar sesi√≥n con Google
async function login() {
    try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        console.log("‚úÖ Usuario autenticado:", user);

        const userRef = doc(db, "usuarios", user.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
            await setDoc(userRef, {
                name: user.displayName,
                email: user.email,
                photoURL: user.photoURL,
                accountType: "google",
                username: user.email.split("@")[0],
                bio: ""
            });
            alert("‚úÖ Usuario nuevo registrado en Firestore");
        } else {
            alert("‚ÑπÔ∏è Usuario ya exist√≠a en Firestore");
        }

        // ‚úÖ Cerrar el modal de bienvenida
        document.getElementById("loginModal")?.classList.add("hidden");

        await loadUserProfile(user.uid);
        closeModal();

    } catch (error) {
        alert("‚ùå Error en login: " + error.message);
        console.error("‚ùå Error en login:", error);
    }
}


    // üìå Funci√≥n para iniciar sesi√≥n como vendedor
    async function loginAsSeller() {
  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;
    console.log("‚úÖ Usuario autenticado como vendedor:", user);

    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      await setDoc(userRef, {
        name: user.displayName,
        email: user.email,
        photoURL: user.photoURL,
        accountType: "seller"
      });
    } else {
      await setDoc(userRef, { accountType: "seller" }, { merge: true });
    }

    // ‚úÖ Cerrar modal de bienvenida
    document.getElementById("loginModal")?.classList.add("hidden");

    // ‚úÖ Cerrar otros modales
    closeModal();

    // ‚úÖ Cargar y sincronizar datos del perfil
    await loadUserProfile(user.uid);
    await syncAccountTypeUI(user); // üî• ACTUALIZA EL MODAL DE VENDEDOR

    // ‚úÖ Mostrar el modal de vendedor directamente
    const sellerModal = document.getElementById("sellerProfileModal");
    if (sellerModal) {
      sellerModal.classList.remove("hidden");
      sellerModal.style.display = "flex";
    }

  } catch (error) {
    console.error("‚ùå Error en login como vendedor:", error);
  }
}



    // üìå Funci√≥n para cerrar sesi√≥n
    async function logout() {
        try {
            await auth.signOut();
            console.log("‚úÖ Usuario cerr√≥ sesi√≥n");
            hideProfileOnLogout(); // Ocultar perfil correctamente
            location.reload();
        } catch (error) {
            console.error("‚ùå Error al cerrar sesi√≥n:", error);
        }
    }

 
   
    // üìå Cargar perfil desde Firestore
async function loadUserProfile(uid) {
    try {
        const userRef = doc(db, "usuarios", uid);
        const userSnap = await getDoc(userRef);

        let userData = {};
        if (userSnap.exists()) {
            userData = userSnap.data();
            console.log("üì• Datos del usuario recuperados de Firestore:", userData);

            // ‚úÖ Actualizar campos de texto en el modal de perfil
            document.getElementById("modalProfileName").textContent = userData.name || auth.currentUser.displayName || "Usuario";
            document.getElementById("modalProfileUsername").textContent = userData.username ? "@" + userData.username : "";
            document.getElementById("modalProfileBio").textContent = userData.bio || "Sin biograf√≠a";
        } else {
            console.warn("‚ö†Ô∏è No se encontr√≥ un documento en Firestore para el usuario:", uid);
        }

        // ‚úÖ Imagen de perfil
        const user = auth.currentUser;
        let profilePhoto = userData.modalPhotoURL || userData.photoURL || (user ? user.photoURL : null);

        if (!profilePhoto) {
            console.warn("‚ö†Ô∏è No se encontr√≥ ninguna imagen en Firestore ni en Firebase Auth.");
            profilePhoto = "https://via.placeholder.com/80";
        }

        const profilePicModal = document.getElementById("profilePicModal");
        if (profilePicModal) {
            profilePicModal.src = profilePhoto;
            console.log("üñºÔ∏è Imagen cargada en el modal:", profilePhoto);
        }

    } catch (error) {
        console.error("‚ùå Error al cargar perfil:", error);
    }
}


// üìå Actualiza tu funci√≥n updateUI as√≠ para evitar conflictos y p√©rdida de imagen:
function updateUI(user) {
    if (!user) return;                                                                                                                 
    console.log("üìå Tipo de cuenta detectado:", user.accountType);                                                                     
    const profilePic = document.getElementById("profilePic");
    const profilePicSidebar = document.getElementById("profilePicSidebar");
    // Usamos la foto original de Google para la interfaz principal
    const mainPhoto = user.photoURL || "https://via.placeholder.com/40";
    if (profilePic) profilePic.src = mainPhoto;
    if (profilePicSidebar) profilePicSidebar.src = mainPhoto;
    // Eliminamos la actualizaci√≥n del modal para no sobreescribir la imagen personalizada
    const profileName = document.getElementById("profileName");
    if (profileName) profileName.textContent = user.name || "Usuario";
    const profileContainer = document.getElementById("profileContainer");
    if (profileContainer) profileContainer.dataset.userType = user.accountType;
    if (user.accountType === "google") {
        document.getElementById("sellerProfileModal")?.classList.add("hidden");
        document.getElementById("googleProfileModal")?.classList.remove("hidden");
    } else if (user.accountType === "seller") {
        document.getElementById("googleProfileModal")?.classList.add("hidden");
        document.getElementById("sellerProfileModal")?.classList.remove("hidden");
    }
}


async function syncAccountTypeUI(user) {
    if (!user) return;

    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) return;

    const userData = userSnap.data();
    const accountType = userData.accountType || "google";

    // Cambiar texto del bot√≥n
    const switchBtn = document.getElementById("switchToSellerBtn");
    if (switchBtn) {
        switchBtn.textContent =
            accountType === "seller"
                ? "Cambiar a cuenta de comprador"
                : "Cambiar a cuenta de vendedor";
    }

    // Mostrar el modal correcto si es necesario (por ejemplo, si ya estaba abierto)
    const profileContainerSidebar = document.getElementById("profileContainerSidebar");
    if (profileContainerSidebar) {
        profileContainerSidebar.dataset.accountType = accountType;
    }

    // Actualizar foto y datos en el modal que est√© visible
    if (accountType === "seller") {
        document.getElementById("sellerName").textContent = userData.name || "Vendedor";
        document.getElementById("sellerUsername").textContent = "@" + (userData.username || "usuario");
        document.getElementById("sellerBio").textContent = userData.bio || "Sin biograf√≠a";
        const sellerPic = userData.modalPhotoURL || userData.photoURL || user.photoURL || "https://via.placeholder.com/100";
        document.getElementById("sellerProfilePic").src = sellerPic;
    }
}








let unsubscribePosts = null;
let userDataLoaded = false;

onAuthStateChanged(auth, async (user) => {
  console.log("üîÑ Detectando cambios en la sesi√≥n...", user);

  const loginBtn = document.getElementById("loginBtn");
  const profileContainer = document.getElementById("profileContainer");
  const profilePic = document.getElementById("profilePic");
  const profileName = document.getElementById("profileName");
  const profileContainerSidebar = document.getElementById("profileContainerSidebar");
  const profilePicSidebar = document.getElementById("profilePicSidebar");
  const usernameSidebar = document.getElementById("usernameSidebar");
  const profilePicModal = document.getElementById("profilePicModal");
  const publishBtn = document.getElementById("publishBtn");

  if (user) {
    console.log("‚úÖ Sesi√≥n detectada: ", user.uid);

    let mainPhoto = user.photoURL || "https://via.placeholder.com/40";

    try {
      const userRef = doc(db, "usuarios", user.uid);
      const userSnap = await getDoc(userRef);
      let userData = userSnap.exists() ? userSnap.data() : null;

      if (!userData) {
        console.log("üÜï Usuario no exist√≠a, creando perfil con UID...");

        userData = {
          uid: user.uid,
          username: user.displayName?.toLowerCase().replace(/\s+/g, "_") || "usuario_" + user.uid.slice(0, 4),
          name: user.displayName || "Usuario",
          photoURL: user.photoURL || "https://via.placeholder.com/40",
          modalPhotoURL: user.photoURL || "https://via.placeholder.com/40",
          accountType: "usuario",
          createdAt: serverTimestamp()
        };

        await setDoc(userRef, userData);
        console.log("üìù Perfil creado correctamente en Firestore.");

        await new Promise(res => setTimeout(res, 300));
      }

      mainPhoto = userData.modalPhotoURL || userData.photoURL || mainPhoto;

      if (profilePicModal) profilePicModal.src = mainPhoto;
      if (profileName) profileName.textContent = userData.name || "Usuario";
      if (profilePic) profilePic.src = mainPhoto;
      if (profilePicSidebar) profilePicSidebar.src = mainPhoto;
      if (usernameSidebar) usernameSidebar.textContent = userData.name || "Usuario";

      await syncAccountTypeUI(user);

      if (loginBtn) loginBtn.style.display = "none";
      if (profileContainer) profileContainer.style.display = "block";
      if (profileContainerSidebar) profileContainerSidebar.classList.remove("hidden");

      // üëâ Abrir tu propio perfil desde el sidebar
      profileContainerSidebar.addEventListener("click", () => {
        const isSeller = userData.accountType === "vendedor";

        // Cerrar ambos modales primero
        document.getElementById("profileModal").classList.add("hidden");
        document.getElementById("sellerProfileModal").classList.add("hidden");

        if (isSeller) {
          // üßº Limpiar contenido del modal vendedor antes de reutilizar
          document.getElementById("sellerProfilePic").src = "https://via.placeholder.com/100";
          document.getElementById("sellerName").textContent = "";
          document.getElementById("sellerUsername").textContent = "";
          document.getElementById("sellerBio").textContent = "";

          // üë§ Insertar tus datos
          document.getElementById("sellerProfilePic").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/100";
          document.getElementById("sellerName").textContent = userData.name || "Vendedor";
          document.getElementById("sellerUsername").textContent = "@" + (userData.username || "usuario");
          document.getElementById("sellerBio").textContent = userData.bio || "";

          // üü¢ Mostrar modal vendedor
          document.getElementById("sellerProfileModal").classList.remove("hidden");
        } else {
          document.getElementById("modalProfileName").textContent = userData.name || "Usuario";
          document.getElementById("modalProfileUsername").textContent = "@" + (userData.username || "usuario");
          document.getElementById("modalProfileBio").textContent = userData.bio || "";
          document.getElementById("profilePicModal").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/80";

          document.getElementById("profileModal").classList.remove("hidden");
          document.getElementById("modalContent").classList.remove("scale-95", "opacity-0");
        }
      });

      if (unsubscribePosts) unsubscribePosts();

      console.log("üü¢ Esperando para cargar publicaciones...");
      setTimeout(() => {
        console.log("üì° Iniciando listenForPosts()");
        listenForPosts();
      }, 400);

      userDataLoaded = true;
      if (publishBtn) publishBtn.disabled = false;

    } catch (error) {
      console.error("‚ùå Error al recuperar/crear datos del usuario:", error);
      if (publishBtn) publishBtn.disabled = true;
      userDataLoaded = false;
    }

  } else {
    console.log("üö™ No hay usuario, cerrando sesi√≥n visual...");

    if (loginBtn) loginBtn.style.display = "block";
    if (profileContainer) profileContainer.style.display = "none";
    if (profileContainerSidebar) profileContainerSidebar.classList.add("hidden");
    hideProfileOnLogout();

    if (unsubscribePosts) unsubscribePosts();

    if (publishBtn) publishBtn.disabled = true;
    userDataLoaded = false;
  }
});








// üìå Funci√≥n para ocultar el perfil al cerrar sesi√≥n
function hideProfileOnLogout() {
    const profileContainerSidebar = document.getElementById("profileContainerSidebar");
    profileContainerSidebar.classList.add("hidden");

    const profilePic = document.getElementById("profilePic");
    const profileName = document.getElementById("profileName");
    const loginBtn = document.getElementById("loginBtn");

    if (profilePic) profilePic.src = "";
    if (profileName) profileName.textContent = "";
    if (loginBtn) loginBtn.style.display = "block";

// Sistema de notificaciones mejorado
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type} fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg transition`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Limpieza al salir de la p√°gina
window.addEventListener('beforeunload', () => {
    if (unsubscribePosts) {
        unsubscribePosts();
    }
});

// Inicializaci√≥n de la persistencia de Firestore
async function enablePersistence() {
    try {
        await enableIndexedDbPersistence(db);
        console.log("Persistencia de Firestore habilitada");
    } catch (err) {
        if (err.code == 'failed-precondition') {
            console.warn("Persistencia fall√≥: M√∫ltiples pesta√±as abiertas");
        } else if (err.code == 'unimplemented') {
            console.warn("Persistencia no soportada en este navegador");
        }
    }
}

enablePersistence();    const profilePicSidebar = document.getElementById("profilePicSidebar");
    if (profilePicSidebar) profilePicSidebar.src = "";
}


// üìå Eventos de UI
document.getElementById("loginBtn")?.addEventListener("click", () => {
    document.getElementById("loginModal")?.classList.remove("hidden");
});

document.getElementById("closeModal")?.addEventListener("click", () => {
    document.getElementById("loginModal")?.classList.add("hidden");
});

document.getElementById("googleLoginBtn")?.addEventListener("click", login);
document.getElementById("sellerLoginBtn")?.addEventListener("click", loginAsSeller);
document.getElementById("logoutBtn")?.addEventListener("click", logout);

document.getElementById("editProfileBtn")?.addEventListener("click", async () => {
    document.getElementById("editProfileModal")?.classList.remove("hidden");

    const user = auth.currentUser;
    if (user) {
        const userRef = doc(db, "usuarios", user.uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
            const userData = userSnap.data();

            // üîÑ Imagen de perfil personalizada o fallback
            const photoURL = userData.modalPhotoURL || userData.photoURL || user.photoURL || "https://via.placeholder.com/80";
            document.getElementById("editProfilePic").src = photoURL;

            // Datos de perfil
            document.getElementById("editProfileName").value = userData.name || user.displayName || "";
            document.getElementById("editProfileUsername").value = (userData.username || "").replace(/^@/, "");
            document.getElementById("editProfileBio").value = userData.bio || "";
        }
    }
});

document.getElementById("closeEditProfileModal")?.addEventListener("click", () => {
    document.getElementById("editProfileModal")?.classList.add("hidden");
});

document.getElementById("saveProfileBtn")?.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
        alert("‚ùå No hay usuario autenticado.");
        return;
    }

    const newName = document.getElementById("editProfileName").value.trim();
    const rawUsername = document.getElementById("editProfileUsername").value.trim();
    const newUsername = rawUsername.replace(/^@/, "").trim(); // sin @
    const newBio = document.getElementById("editProfileBio").value.trim();

    try {
        // Actualizar displayName en Auth
        await user.updateProfile({ displayName: newName });

        // Guardar en Firestore
        const userRef = doc(db, "usuarios", user.uid);
        await setDoc(userRef, {
            name: newName,
            username: newUsername,
            bio: newBio
        }, { merge: true });

        console.log("‚úÖ Perfil actualizado correctamente.");
        alert("‚úÖ Perfil actualizado con √©xito.");

        // Refrescar datos en el modal principal
        await loadUserProfile(user.uid);

        // Cerrar el modal de edici√≥n
        document.getElementById("editProfileModal").classList.add("hidden");
    } catch (error) {
        console.error("‚ùå Error al actualizar el perfil:", error);
    }
});


// Define estas funciones fuera del DOMContentLoaded para que sean globales
function openModal() {
    const user = auth.currentUser;
    if (!user) return;

    const userRef = doc(db, "usuarios", user.uid);
    getDoc(userRef).then((userSnap) => {
        if (userSnap.exists()) {
            const userData = userSnap.data();
            const accountType = userData.accountType || "google";

            if (accountType === "seller") {
                // Mostrar modal de vendedor
                const sellerModal = document.getElementById("sellerProfileModal");
                if (sellerModal) {
                    sellerModal.classList.remove("hidden");
                    sellerModal.style.display = "flex";
                }
            } else {
                // Mostrar modal cl√°sico
                const profileModal = document.getElementById("profileModal");
                const modalOverlay = document.getElementById("modalOverlay");
                const modalContent = document.getElementById("modalContent");

                if (!profileModal || !modalOverlay || !modalContent) {
                    console.error("‚ùå No se encontraron elementos del modal.");
                    return;
                }

                profileModal.classList.remove("hidden");
                profileModal.style.display = "flex";
                modalOverlay.classList.remove("hidden");

                setTimeout(() => {
                    modalContent.classList.remove("scale-95", "opacity-0");
                    modalContent.classList.add("scale-100", "opacity-100");
                }, 10);

                document.body.style.overflow = "hidden";

                const profilePicModal = document.getElementById("profilePicModal");
                if (profilePicModal) {
                    profilePicModal.src = user.photoURL || "https://via.placeholder.com/80";
                }

                loadUserProfile(user.uid);
            }
        }
    }).catch((error) => {
        console.error("‚ùå Error al verificar tipo de cuenta:", error);
    });
}

function closeModal() {
    const profileModal = document.getElementById("profileModal");
    const modalOverlay = document.getElementById("modalOverlay");
    const modalContent = document.getElementById("modalContent");

    if (!profileModal || !modalOverlay || !modalContent) {
        console.error("‚ùå No se encontraron elementos del modal.");
        return;
    }

    modalContent.classList.add("scale-95", "opacity-0");
    modalContent.classList.remove("scale-100", "opacity-100");

    setTimeout(() => {
        profileModal.classList.add("hidden");
        profileModal.style.display = "none";
        modalOverlay.classList.add("hidden");
        document.body.style.overflow = "auto";
    }, 300);
}


document.addEventListener("DOMContentLoaded", function () {
    const profileContainerSidebar = document.getElementById("profileContainerSidebar");
    const closeProfileModal = document.getElementById("closeProfileModal");
    const modalOverlay = document.getElementById("modalOverlay");

    if (!profileContainerSidebar || !closeProfileModal || !modalOverlay) {
        console.error("‚ùå Error: No se encontraron algunos elementos del modal.");
        return;
    }

    profileContainerSidebar.addEventListener("click", openModal);
    closeProfileModal.addEventListener("click", closeModal);
    modalOverlay.addEventListener("click", closeModal);

    document.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
            closeModal();
        }
    });
    // ... el resto del c√≥digo dentro de DOMContentLoaded
});


document.getElementById("openEditProfileFromModal").addEventListener("click", function () {
    // Cerrar el modal del perfil
    closeModal();

    // Abrir el modal de edici√≥n de perfil
    openEditProfileModal();
});


function openEditProfileModal() {
    const editProfileModal = document.getElementById("editProfileModal");
    if (!editProfileModal) {
        console.error("‚ùå No se encontr√≥ el modal de edici√≥n de perfil.");
        return;
    }

    editProfileModal.classList.remove("hidden");
    editProfileModal.style.display = "flex";

    setTimeout(() => {
        editProfileModal.classList.remove("scale-95", "opacity-0");
        editProfileModal.classList.add("scale-100", "opacity-100");
    }, 10);

    const user = auth.currentUser;
    if (user) {
        const userRef = doc(db, "usuarios", user.uid);
        getDoc(userRef).then((userSnap) => {
            if (userSnap.exists()) {
                const userData = userSnap.data();

                // ‚úÖ Imagen de perfil personalizada
                const profilePicUrl = userData.modalPhotoURL || user.photoURL || "https://via.placeholder.com/80";
                document.getElementById("editProfilePic").src = profilePicUrl;

                // ‚úÖ Datos del usuario
                document.getElementById("editProfileName").value = userData.name || user.displayName || "";
                document.getElementById("editProfileUsername").value = (userData.username || "").replace(/^@/, "");
                document.getElementById("editProfileBio").value = userData.bio || "";

                // ‚úÖ Cambiar texto del bot√≥n seg√∫n el tipo de cuenta
                const switchBtn = document.getElementById("switchToSellerBtn");
                if (switchBtn) {
                    if (userData.accountType === "seller") {
                        switchBtn.textContent = "Cambiar a cuenta de comprador";
                    } else {
                        switchBtn.textContent = "Cambiar a cuenta de vendedor";
                    }
                }
            }
        }).catch((error) => {
            console.error("‚ùå Error al recuperar datos del usuario:", error);
        });
    }
}


// Abrir modal de edici√≥n desde el perfil de vendedor
document.getElementById("editSellerProfileBtn")?.addEventListener("click", () => {
    // Ocultar el modal de perfil de vendedor
    document.getElementById("sellerProfileModal")?.classList.add("hidden");
    document.getElementById("sellerProfileModal").style.display = "none";

    // Abrir el modal de edici√≥n de perfil
    openEditProfileModal();
});



document.getElementById("saveProfileBtn").addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
        alert("‚ùå No hay usuario autenticado.");
        return;
    }

    const newName = document.getElementById("editProfileName").value.trim();
    const rawUsername = document.getElementById("editProfileUsername").value.trim();
    const newUsername = rawUsername.replace(/^@/, "").trim();
    const newBio = document.getElementById("editProfileBio").value.trim();

    try {
        // ‚úÖ Actualizar nombre en Firebase Auth correctamente
        await updateProfile(user, { displayName: newName });

        // ‚úÖ Guardar en Firestore
        const userRef = doc(db, "usuarios", user.uid);
        await setDoc(userRef, {
            name: newName,
            username: newUsername,
            bio: newBio
        }, { merge: true });

        alert("‚úÖ Perfil actualizado con √©xito.");
        await loadUserProfile(user.uid);

        // Actualizar los elementos del modal directamente
        const updatedSnap = await getDoc(userRef);
        if (updatedSnap.exists()) {
            const updatedData = updatedSnap.data();
            document.getElementById("modalProfileName").textContent = updatedData.name;
            document.getElementById("modalProfileUsername").textContent = "@" + updatedData.username;
            document.getElementById("modalProfileBio").textContent = updatedData.bio || "Sin biograf√≠a";
        }

        document.getElementById("editProfileModal").classList.add("hidden");

    } catch (error) {
        console.error("‚ùå Error al actualizar el perfil:", error);
        alert("‚ùå Ocurri√≥ un error al actualizar el perfil.\n" + error.message);
    }
});



document.getElementById("switchToSellerBtn")?.addEventListener("click", async () => {
    const user = auth.currentUser;
    if (!user) {
        alert("‚ùå No hay usuario autenticado.");
        return;
    }

    try {
        const userRef = doc(db, "usuarios", user.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
            alert("‚ö†Ô∏è No se encontraron datos del usuario.");
            return;
        }

        const userData = userSnap.data();
        const currentType = userData.accountType || "google";

        // üîÅ Cambiar el tipo de cuenta din√°micamente
        const newType = currentType === "seller" ? "google" : "seller";
        const newLabel = newType === "seller" ? "Cambiar a cuenta de comprador" : "Cambiar a cuenta de vendedor";

        await setDoc(userRef, { accountType: newType }, { merge: true });
        alert(`‚úÖ Tu cuenta ahora es tipo: ${newType}`);

        // üîÑ Actualizar texto del bot√≥n
        const switchBtn = document.getElementById("switchToSellerBtn");
        if (switchBtn) switchBtn.textContent = newLabel;

        // üîí Cerrar modales previos
        document.getElementById("editProfileModal")?.classList.add("hidden");
        document.getElementById("profileModal")?.classList.add("hidden");
        document.getElementById("profileModal").style.display = "none";
        document.getElementById("sellerProfileModal")?.classList.add("hidden");
        document.getElementById("sellerProfileModal").style.display = "none";

        // üîÑ Actualizar UI
        const updatedSnap = await getDoc(userRef);
        if (updatedSnap.exists()) {
            const data = updatedSnap.data();

            if (newType === "seller") {
                document.getElementById("sellerName").textContent = data.name || "Vendedor";
                document.getElementById("sellerUsername").textContent = "@" + (data.username || "usuario");
                document.getElementById("sellerBio").textContent = data.bio || "Sin biograf√≠a";

                const sellerPic = data.modalPhotoURL || data.photoURL || user.photoURL || "https://via.placeholder.com/100";
                document.getElementById("sellerProfilePic").src = sellerPic;

                const sellerModal = document.getElementById("sellerProfileModal");
                if (sellerModal) {
                    sellerModal.classList.remove("hidden");
                    sellerModal.style.display = "flex";
                }
            }
        }

    } catch (error) {
        console.error("‚ùå Error al cambiar tipo de cuenta:", error);
        alert("‚ùå Hubo un error al cambiar el tipo de cuenta.");
    }
});


document.addEventListener("DOMContentLoaded", () => {
  // üëâ Abrir modal de PEDIDOS
  const openOrdersBtn = document.getElementById("openOrdersModal");
  const ordersModal = document.getElementById("ordersModal");
  const closeOrdersBtn = document.getElementById("closeOrdersModal");

  openOrdersBtn?.addEventListener("click", () => {
    ordersModal?.classList.remove("hidden");
    ordersModal.style.display = "flex";
  });

  closeOrdersBtn?.addEventListener("click", () => {
    ordersModal?.classList.add("hidden");
    ordersModal.style.display = "none";
  });

  ordersModal?.addEventListener("click", (e) => {
    if (e.target.id === "ordersModal") {
      ordersModal.classList.add("hidden");
      ordersModal.style.display = "none";
    }
  });

  // üëâ Abrir modal de INGRESOS
  const openEarningsBtn = document.getElementById("openEarningsModal");
  const earningsModal = document.getElementById("earningsModal");
  const closeEarningsBtn = document.getElementById("closeEarningsModal");

  openEarningsBtn?.addEventListener("click", () => {
    earningsModal?.classList.remove("hidden");
    earningsModal.style.display = "flex";
  });

  closeEarningsBtn?.addEventListener("click", () => {
    earningsModal?.classList.add("hidden");
    earningsModal.style.display = "none";
  });

  earningsModal?.addEventListener("click", (e) => {
    if (e.target.id === "earningsModal") {
      earningsModal.classList.add("hidden");
      earningsModal.style.display = "none";
    }
  });

  
  
  // üëâ Cerrar modal de vendedor
  const closeSellerBtn = document.getElementById("closeSellerModal");
  const sellerModal = document.getElementById("sellerProfileModal");

  closeSellerBtn?.addEventListener("click", () => {                                                                                        sellerModal?.classList.add("hidden");
    sellerModal.style.display = "none";                                                                                                  });

  sellerModal?.addEventListener("click", (e) => {
    if (e.target.id === "sellerProfileModal") {
      sellerModal.classList.add("hidden");
      sellerModal.style.display = "none";
    }
  });
});



window.openModalFromPost = function(uid) {
  getDoc(doc(db, "usuarios", uid)).then(userSnap => {
    if (!userSnap.exists()) return;

    const userData = userSnap.data();

    // üîí Cerrar modales por si acaso
    document.getElementById("profileModal")?.classList.add("hidden");
    document.getElementById("sellerProfileModal")?.classList.add("hidden");

    // ‚úÖ FORZAR siempre el modal normal, aunque sea vendedor
    document.getElementById("modalProfileName").textContent = userData.name || "Usuario";
    document.getElementById("modalProfileUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("modalProfileBio").textContent = userData.bio || "Sin biograf√≠a";
    document.getElementById("profilePicModal").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/80";

    const modal = document.getElementById("profileModal");
    const modalContent = document.getElementById("modalContent");
    const modalOverlay = document.getElementById("modalOverlay");

    modal.classList.remove("hidden");
    modal.style.display = "flex";

    if (modalOverlay) {
      modalOverlay.classList.remove("hidden");
      modalOverlay.style.display = "block";
    }

    setTimeout(() => {
      modalContent.classList.remove("scale-95", "opacity-0");
      modalContent.classList.add("scale-100", "opacity-100");
    }, 10);
  }).catch(error => {
    console.error("‚ùå Error al abrir modal desde publicaci√≥n:", error);
    alert("‚ùå No se pudo abrir el perfil.");
  });
};



// Al hacer clic en el nombre del usuario
document.addEventListener("click", (e) => {
    if (e.target.classList.contains("username-link")) {
        const uid = e.target.dataset.uid;
        if (uid) openModalFromPost(uid);
    }
});

// Al hacer clic en la imagen del perfil ‚Üí vista previa grande
document.addEventListener("click", (e) => {
    if (e.target.classList.contains("profile-pic-clickable")) {
        const modal = document.getElementById("profilePicPreviewModal");
        const img = document.getElementById("previewProfilePic");
        img.src = e.target.dataset.img;
        modal.classList.remove("hidden");
    }
});

// Cerrar modal de imagen al hacer clic fuera del c√≠rculo
document.getElementById("profilePicPreviewModal")?.addEventListener("click", (e) => {
    if (e.target.id === "profilePicPreviewModal") {
        e.currentTarget.classList.add("hidden");
    }
});











// üü¢ PUBLICAR POST (guarda perfil en el post)
document.getElementById("publishBtn")?.addEventListener("click", async () => {
  const text = document.getElementById("postInput").value.trim();
  const imageInput = document.getElementById("postImageInput");
  const file = imageInput.files[0];

  if (!text && !file) {
    alert("‚ö†Ô∏è Escribe algo o sube una imagen o video.");
    return;
  }

  const user = auth.currentUser;
  if (!user) {
    alert("‚ö†Ô∏è Debes estar logueado.");
    return;
  }

  if (!userDataLoaded) {
    alert("‚ö†Ô∏è Espera a que se cargue tu perfil correctamente antes de publicar.");
    return;
  }

  let mediaURL = "";
  let isVideo = false;

  if (file) {
    try {
      const fileType = file.type;
      isVideo = fileType.startsWith("video/");

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", "Tweetsocial");

      const uploadURL = isVideo
        ? "https://api.cloudinary.com/v1_1/dz70korgo/video/upload"
        : "https://api.cloudinary.com/v1_1/dz70korgo/image/upload";

      const response = await fetch(uploadURL, {
        method: "POST",
        body: formData
      });

      const data = await response.json();

      if (!data.secure_url) {
        alert("‚ùå Error al subir el archivo a Cloudinary.");
        return;
      }

      mediaURL = data.secure_url;
    } catch (error) {
      console.error("‚ùå Error al subir archivo:", error);
      alert("‚ùå Ocurri√≥ un error al subir el archivo.");
      return;
    }
  }

  // üî• Leer perfil desde Firestore
  let profileData = {};
  try {
    const userRef = doc(db, "usuarios", user.uid);
    const userSnap = await getDoc(userRef);
    if (userSnap.exists()) {
      const data = userSnap.data();
      profileData = {
        accountType: data.accountType || "",
        bio: data.bio || "",
        modalPhotoURL: data.modalPhotoURL || "",
        name: data.name || "",
        username: data.username || "",
        photoURL: data.photoURL || "" // Asegura que se incluya la imagen de Google si no hay modalPhotoURL
      };
    }
  } catch (e) {
    console.warn("‚ö†Ô∏è No se pudo obtener perfil del usuario:", e);
  }

  // üî• Publicar en Firestore con perfil incluido
  try {
    await addDoc(collection(db, "posts"), {
      uid: user.uid,
      text: text,
      mediaURL: mediaURL,
      isVideo: isVideo,
      timestamp: serverTimestamp(),
      ...profileData // üëà Aqu√≠ se agrega el perfil al post
    });

    document.getElementById("postInput").value = "";
    imageInput.value = "";

    alert("‚úÖ Publicaci√≥n realizada con √©xito.");
  } catch (err) {
    console.error("‚ùå Error al guardar la publicaci√≥n:", err);
    alert("‚ùå Error al guardar la publicaci√≥n en Firestore.");
  }
});




// üëÅÔ∏è ESCUCHAR PUBLICACIONES EN TIEMPO REAL (Versi√≥n final y sincronizada)
function listenForPosts() {
  const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));

  unsubscribePosts = onSnapshot(q, (snapshot) => {
    const postsContainer = document.getElementById("postsContainer");
    if (!postsContainer) return console.error("‚ùå No se encontr√≥ #postsContainer.");

    const postHTMLArray = [];

    snapshot.forEach((docSnap) => {
      const postData = docSnap.data();
      if (!postData?.uid) return;

      // ‚úÖ Ya viene todo desde el post (name, username, photoURL, etc.)
      postHTMLArray.push(renderPostHTML(postData));
    });

    postsContainer.innerHTML = postHTMLArray.join("");
  }, (error) => {
    console.error("üî• Error en snapshot de posts:", error);
    const postsContainer = document.getElementById("postsContainer");
    if (postsContainer) {
      postsContainer.innerHTML = `<div class="text-center py-4 text-red-500">Error al cargar publicaciones.</div>`;
    }
  });
}



function renderPostHTML(docData, userData = {}) {
  const safeUser = {
    username: docData.username || userData.username || "usuario",
    name: docData.name || userData.name || "Usuario",
    photoURL: docData.modalPhotoURL || docData.photoURL || userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/40",
    accountType: docData.accountType || userData.accountType || "usuario"
  };

  return `
    <div class="bg-white p-5 rounded shadow-md mt-4">
      <div class="flex items-center mb-2">
        <img src="${safeUser.photoURL}"
             class="w-10 h-10 rounded-full cursor-pointer profile-pic-clickable"
             data-uid="${docData?.uid || userData?.uid || ''}"
             data-account-type="${safeUser.accountType}"
             alt="Foto de ${safeUser.name}"
             onerror="this.src='https://via.placeholder.com/40'" />
        <span class="ml-2 text-blue-600 cursor-pointer username-link"
              data-uid="${docData?.uid || userData?.uid || ''}"
              data-account-type="${safeUser.accountType}">
          @${safeUser.username}
        </span>
      </div>
      <p class="text-gray-700">${docData.text || ""}</p>
      ${
        docData.mediaURL
          ? docData.isVideo
            ? `<video controls class="mt-2 max-h-60 mx-auto rounded">
                 <source src="${docData.mediaURL}" type="video/mp4">
               </video>`
            : `<div class="mt-2">
                 <img src="${docData.mediaURL}"
                      class="max-h-40 object-cover mx-auto rounded"
                      alt="Contenido multimedia"
                      onerror="this.style.display='none'" />
               </div>`
          : ""
      }
      <div class="flex mt-3 space-x-4">
        <button class="text-gray-600">üí¨ Comentar</button>
        <button class="text-red-500">‚ù§Ô∏è</button>
        <button class="text-gray-600">üîó</button>
      </div>
    </div>
  `;
}




document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("username-link")) return;

  const uid = e.target.dataset.uid;
  if (!uid) {
    alert("‚ùå No se pudo identificar el UID del usuario.");
    return;
  }

  console.log("üîç Clic en username, buscando datos para UID:", uid);

  try {
    const userRef = doc(db, "usuarios", uid);
    const userSnap = await getDoc(userRef);

    if (!userSnap.exists()) {
      alert("‚ùå Usuario no encontrado en Firestore.");
      return;
    }

    const userData = userSnap.data();
    console.log("‚úÖ Datos del usuario:", userData);

    // üîí Cerrar ambos modales por si acaso
    document.getElementById("profileModal")?.classList.add("hidden");
    document.getElementById("sellerProfileModal")?.classList.add("hidden");

    // üîÑ Mostrar siempre modal normal
    document.getElementById("profilePicModal").src = userData.modalPhotoURL || userData.photoURL || "https://via.placeholder.com/80";
    document.getElementById("modalProfileName").textContent = userData.name || "Usuario";
    document.getElementById("modalProfileUsername").textContent = "@" + (userData.username || "usuario");
    document.getElementById("modalProfileBio").textContent = userData.bio || "";

    // üëâ Mostrar u ocultar bot√≥n "Editar perfil"
    const editBtn = document.getElementById("openEditProfileFromModal");
    if (auth.currentUser && auth.currentUser.uid === uid) {
      editBtn.classList.remove("hidden");
    } else {
      editBtn.classList.add("hidden");
    }

    // üî• Mostrar modal
    const modal = document.getElementById("profileModal");
    const content = document.getElementById("modalContent");

    modal.classList.remove("hidden");
    modal.style.display = "flex";

    setTimeout(() => {
      content.classList.remove("scale-95", "opacity-0");
      content.classList.add("scale-100", "opacity-100");
    }, 10);

  } catch (err) {
    console.error("‚ùå Error al obtener perfil:", err);
    alert("‚ùå No se pudo abrir el perfil.");
  }
});




// üëá Evento para abrir/cerrar el modal de la imagen de perfil
document.addEventListener("DOMContentLoaded", () => {
  const profileModal = document.getElementById("profilePicPreviewModal");
  const profileImgPreview = document.getElementById("previewProfilePic");

  document.addEventListener("click", (e) => {
    if (e.target.classList.contains("profile-pic-clickable")) {
      const src = e.target.getAttribute("src");
      profileImgPreview.src = src;
      profileModal.classList.remove("hidden");
    }
  });

  profileModal.addEventListener("click", (e) => {
    if (e.target === profileModal) {
      profileModal.classList.add("hidden");
      profileImgPreview.src = "";
    }
  });
});






</script>
</body>
</html>
